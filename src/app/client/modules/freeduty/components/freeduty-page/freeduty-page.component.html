<div class="card-content" id="step1">
  <p-toolbar styleClass="p-mb-4">
    <ng-template pTemplate="left">
      <div class="button-content p-mr-2" (click)="openDateModal()">
        {{filterForm.value.dateFrom | date: 'dd.MM.yyyy'}} - {{filterForm.value.dateTo | date: 'dd.MM.yyyy'}}
      </div>
      <button type="button" pButton label="Показать всё" class="basic p-mr-2" (click)="showAll()"></button>
      <button type="button" pButton label="Обновить данные" class="basic p-mr-2" (click)="applyFilters()"></button>
      <button type="button" pButton label="Создать заявку ({{selectedItems.length}})" class="basic"
        (click)="openCreateRequestModal()"></button>
    </ng-template>
  </p-toolbar>
  <p-table [value]="(freeduty$ | async)" [rows]="10" [showCurrentPageReport]="true" selectionMode="multiple"
    [scrollable]="true" [rowsPerPageOptions]="[10,25,50]" [(selection)]="selectedItems" dataKey="ID"
    styleClass="p-datatable-customers mib-table" [paginator]="true" [metaKeySelection]="true"
    currentPageReportTemplate="Показано: от {first} до {last} из {totalRecords}">
    <ng-template pTemplate="colgroup" let-columns>
      <colgroup>
        <col style="width:3rem">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
        <col style="width:180px">
      </colgroup>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th>
          <div class="m-th" tooltipPosition="bottom" pTooltip="ID задолженности">
            <div>ID задолженности</div>
          </div>
        </th>
        <th>
          <div class="m-th">
            <div>Накладная №</div>
          </div>
        </th>
        <th>
          <div class="m-th" tooltipPosition="bottom" pTooltip="Дата накладной">
            <div>Дата накладной</div>
          </div>
        </th>
        <th>
          <div class="m-th">
            <div>Дата платежа</div>
          </div>
        </th>
        <th>
          <div class="m-th" tooltipPosition="bottom" pTooltip="Сумма остатка задолженности">
            <div>Сумма остатка задолж.</div>
          </div>
        </th>
        <th>
          <div class="m-th">
            <div>Договор</div>
          </div>
        </th>
        <th>
          <div class="m-th">
            <div>Дебитор</div>
          </div>
        </th>
        <th>
          <div class="m-th">
            <div>Комментарий</div>
          </div>
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-item>
      <tr
        [ngClass]="{'warn': item.Statistics.PaymentExpire === true, 'success': item.Statistics.ShipmentID}">
        <td>
          <p-tableCheckbox [value]="item"></p-tableCheckbox>
        </td>
        <td>
          <div class="m-td">
            <div>
              {{item.ID}}
            </div>
          </div>
        </td>
        <td>
          <div class="m-td">
            <div>{{item.Number}}</div>
          </div>
        </td>
        <td>
          <div class="m-td">
            <div>{{item.DateDuty | date: 'dd.MM.yyyy'}}</div>
          </div>
        </td>
        <td>
          <div class="m-td">
            <div>{{item.DatePayment | date: 'dd.MM.yyyy'}}</div>
          </div>
        </td>
        <td>
          <div class="m-td" tooltipPosition="bottom" pTooltip="{{item.Summ | currency: 'RUB'}}">
            <div>{{item.Summ | currency: 'RUB'}}</div>
          </div>
        </td>
        <td>
          <div class="m-td" tooltipPosition="bottom" pTooltip="{{item.Contract.Title}}">
            <div>{{item.Contract.Title}}</div>
          </div>
        </td>
        <td>
          <div class="m-td" tooltipPosition="bottom" pTooltip="{{item.Contract.Client}}">
            <div>{{item.Contract.Client}}</div>
          </div>
        </td>
        <td>
          <div class="m-td">
            <div>{{item.Statistics.Comment}}</div>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td colspan="5" class="p-text-right"></td>
        <td>{{getFreedutySum((freeduty$ | async)) | currency:'RUB':'symbol' }}</td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <ng-container *ngIf="(loading$ | async); else skeletonRequestsTemplate">
        <tr>
          <td colspan="8">Нет данных.</td>
        </tr>
      </ng-container>
      <ng-template #skeletonRequestsTemplate>
        <tr *ngFor="let item of [{}, {}, {}, {}, {}]">
          <td>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>
                <p-skeleton width="10rem"></p-skeleton>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </ng-template>
  </p-table>
</div>

<!-- Filter Form -->
<p-dialog [style]="{width: '450px'}" [(visible)]="filterDialog" [draggable]="false" [resizable]="false"
  header="Укажите период" [modal]="true" styleClass="p-fluid">
  <ng-template pTemplate="content">
    <form [formGroup]="filterForm" (ngSubmit)="saveFilter()">
      <div class="p-field">
        <label for="dateFrom">Дата с: </label>
        <input id="dateFrom" type="date" pInputText placeholder="Дата с" formControlName="dateFrom">
      </div>
      <div class="p-field">
        <label for="dateTo">Дата по: </label>
        <input id="dateTo" type="date" pInputText placeholder="Дата по" formControlName="dateTo">
      </div>
      <div class="modal-actions">
        <button pButton pRipple label="Применить" class="p-button-text save" type="submit"></button>
        <button pButton pRipple label="Отменить" class="p-button-text cancel" (click)="closeDateModal()"></button>
      </div>
    </form>
  </ng-template>
</p-dialog>

<!-- Request Form -->
<p-dialog [style]="{width: '950px'}" [(visible)]="requestsDialog" header="Создать заявку" [modal]="true"
  [draggable]="false" [resizable]="false" styleClass="p-fluid">
  <ng-template pTemplate="content">
    <metib-backend-error-messages *ngIf="errorRequestsDialogMessage" [backendErrors]="errorRequestsDialogMessage">
    </metib-backend-error-messages>

    <metib-success-messages *ngIf="successRequestsDialogMessage" [message]="successRequestsDialogMessage">
    </metib-success-messages>
    <p-table [value]="selectedItemsSorted" dataKey="contract">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"></th>
          <th class="header-width">
            <div class="m-th">
              <div>Договор / Заявка / Накладная</div>
            </div>
          </th>
          <th class="header-width">
            <div class="m-th">
              <div>ID задолженности</div>
            </div>
          </th>
          <th class="header-width">
            <div class="m-th">
              <div>Дата задолженности</div>
            </div>
          </th>
          <th class="header-width">
            <div class="m-th">
              <div>Сумма</div>
            </div>
          </th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-item let-expanded="expanded">
        <tr>
          <td>
            <button type="button" pButton pRipple [pRowToggler]="item"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td>
            <div class="m-td">
              <div>
                {{item.contract}}</div>
            </div>
          </td>
          <td>
            <div class="m-td">
            </div>
          </td>
          <td>
            <div class="m-td">
            </div>
          </td>
          <td>
            <div>
              <div class="m-td">
                Итог - Контракт: {{item.summ | currency:'RUB'}}
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion" let-item>
        <tr>
          <td colspan="7" class="inner">
            <div>
              <p-table [value]="item.categories" dataKey="categoryName">
                <ng-template pTemplate="header">
        <tr class="empty">
          <th style="width: 3rem"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-category let-expandedCategory="expanded">
        <tr>
          <td>
            <button type="button" pButton pRipple [pRowToggler]="category"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expandedCategory ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
          </td>
          <td>
            <div class="m-td">
              <div>{{category.categoryName}}</div>
            </div>
          </td>
          <td>
            <div class="m-td">
            </div>
          </td>
          <td>
            <div class="m-td">
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>{{category.summ | currency:'RUB'}}</div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="rowexpansion" let-category>
        <tr>
          <td colspan="7" class="inner">
            <div>
              <p-table [value]="category.requests" dataKey="id">
                <ng-template pTemplate="header">
        <tr class="empty">
          <th style="width: 3rem"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
          <th class="header-width"></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-request>
        <tr>
          <td></td>
          <td>
            <div class="m-td">
              <div>{{request.id}}</div>
            </div>
          </td>
          <td>
            <div class="m-td">
              <div>{{request.number}}</div>

            </div>
          </td>
          <td>
            <div class="m-td">
              <div>{{request.date | date:'MM.dd.yyyy'}}</div>

            </div>
          </td>
          <td>
            <div class="m-td">
              <div>{{request.summ | currency:'RUB'}}</div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6">Нет данных.</td>
        </tr>
      </ng-template>
    </p-table>
    </div>
    </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="6">Нет данных.</td>
    </tr>
  </ng-template>
  </p-table>
  </div>
  </td>
  </tr>
  </ng-template>
  </p-table>
  </ng-template>
  <ng-template pTemplate="footer">
    <button pButton pRipple label="Создать Заявку" class="p-button-text" type="button" class="btn-mib-submit w-100"
      (click)="createRequests()"></button>
  </ng-template>
</p-dialog>
