<p-toast></p-toast>
<div [ngClass]="{'card-content': isUserVerified}">
  <div class="header lg">
    <div class="title">
      <h2>Запрос на ЭЦП</h2>
    </div>
    <div class="actions">
      <button pButton pRipple type="button" label="Вернуться к списку запросов" class="p-button-outlined p-mr-2"
      (click)="back()" *ngIf="isEdit"></button>
    </div>
  </div>

  <metib-success-messages *ngIf="alert" [message]="alertMessage"></metib-success-messages>

  <ng-container *ngIf="isEdit; else createTemplate;">
    <p-tabView class="mib-tabs">
      <p-tabPanel header="Информация">
        <app-demand-info [currentDemandInfo]="currentInformation" (sendMessage)="handleSendMessage($event)">
        </app-demand-info>
      </p-tabPanel>
      <p-tabPanel header="Данные">
        <ng-container *ngTemplateOutlet="form; context: {formEDS: formEDS}">></ng-container>
      </p-tabPanel>
      <p-tabPanel header="Файлы">
        <app-demand-files (removeFile)="handleRemoveFile($event)" [currentDemandFiles]="currentDemand.Files">
        </app-demand-files>
      </p-tabPanel>
    </p-tabView>
  </ng-container>
  <ng-template #createTemplate>
    <ng-container *ngTemplateOutlet="form; context: {formEDS: formEDS}"></ng-container>
  </ng-template>

  <ng-template #form let-formEDS="formEDS">
    <form [formGroup]="formEDS" (ngSubmit)="onSubmit()">
      <div class="form-actions">
        <button pButton pRipple type="button" label="Вернуться к списку запросов" class="p-button-outlined p-mr-2"
        (click)="back()"></button>
      </div>
      <div class="p-fluid p-formgrid p-grid form">
        <!-- 1 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationType">Тип организации</label>
          <p-dropdown id="organizationType" [options]="organizationTypes" placeholder="Выберите Тип организации"
            formControlName="organizationType" optionLabel="title" optionValue="value"></p-dropdown>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationLegalForm">Правовая форма</label>
          <p-dropdown id="organizationLegalForm" [options]="ruleTypes" placeholder="Выберите Правовую форму"
            formControlName="organizationLegalForm" optionLabel="title" optionValue="value"></p-dropdown>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationShortName">Краткое наименование организации</label>
          <input id="organizationShortName" type="text" pInputText placeholder="Краткое наименование организации"
            formControlName="organizationShortName">
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationFullName">Полное наименование организации</label>
          <input id="organizationFullName" type="text" pInputText placeholder="Полное наименование организации"
            formControlName="organizationFullName">
        </div>
        <!-- 2 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationINN">ИНН</label>
          <input id="organizationINN" type="text" pInputText placeholder="ИНН" minlength="10" maxlength="12"
            formControlName="organizationINN">
          <div *ngIf="formEDS.controls['organizationINN'].invalid">
            <small *ngIf="formEDS.controls['organizationINN'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
            <small *ngIf="formEDS.controls['organizationINN'].errors.minlength" class="p-error">
              Введите корректный ИНН (10 или 12 цифр).
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationKPP">КПП</label>
          <input id="organizationKPP" type="text" pInputText placeholder="КПП" formControlName="organizationKPP">
          <div *ngIf="formEDS.controls['organizationKPP'].invalid">
            <small *ngIf="formEDS.controls['organizationKPP'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationOGRN">ОГРН</label>
          <input id="organizationOGRN" type="text" pInputText placeholder="ОГРН" formControlName="organizationOGRN">
          <div *ngIf="formEDS.controls['organizationOGRN'].invalid">
            <small *ngIf="formEDS.controls['organizationOGRN'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationOKPO">ОКПО</label>
          <input id="organizationOKPO" type="text" pInputText placeholder="ОКПО" formControlName="organizationOKPO">
          <div *ngIf="formEDS.controls['organizationOKPO'].invalid">
            <small *ngIf="formEDS.controls['organizationOKPO'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <!-- 3 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationPhone">Телефон</label>
          <p-inputMask id="organizationPhone" type="tel" placeholder="Телефон" formControlName="organizationPhone"
            mask="+7-999-999-99-99"></p-inputMask>
          <div *ngIf="formEDS.controls['organizationPhone'].invalid">
            <small *ngIf="formEDS.controls['organizationPhone'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="organizationEmail">E-mail</label>
          <input id="organizationEmail" type="email" pInputText placeholder="E-mail"
            formControlName="organizationEmail">
          <div *ngIf="formEDS.controls['organizationEmail'].invalid">
            <small *ngIf="formEDS.controls['organizationEmail'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
            <small *ngIf="formEDS.controls['organizationEmail'].errors.email" class="p-error">
              Введите корректную почту.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-6">
          <label for="organizationWEB">Адрес сайта</label>
          <input id="organizationWEB" type="text" pInputText placeholder="Адрес сайта"
            formControlName="organizationWEB">
          <div *ngIf="formEDS.controls['organizationWEB'].invalid">
            <small *ngIf="formEDS.controls['organizationWEB'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <!-- 4 row -->
        <div class="p-field p-col-12 p-md-6">
          <label for="organizationLegalAddress">Юридический адрес</label>
          <div class="addon-button p-mb-2" formGroupName="organizationLegalAddress">
            <input id="organizationLegalAddress" type="text" pInputText placeholder="Юридический адрес" disabled
              formControlName="displayAddress">
            <button pButton pRipple type="button" label="Изменить" class="p-button-outlined small"
              (click)="openAddressForm('organizationLegalAddress')"></button>
          </div>

          <div class="p-field-checkbox">
            <p-checkbox formControlName="organizationIsActualAdressEqual" binary="true"
              inputId="organizationIsActualAdressEqual" (onChange)="isAddressEqual('organizationLegalAddress')">
            </p-checkbox>
            <label for="organizationIsActualAdressEqual"> Фактический адрес
              совпадает с юридическим</label>
          </div>

        </div>
        <div class="p-field p-col-12 p-md-6">
          <label for="organizationActualAddress">Фактический адрес</label>
          <div class="addon-button p-mb-2" formGroupName="organizationActualAddress">
            <input id="organizationActualAddress" type="text" pInputText placeholder="Фактический адрес" disabled
              formControlName="displayAddress">
            <button pButton pRipple type="button" label="Изменить" class="p-button-outlined small"
              (click)="openAddressForm('organizationActualAddress')"></button>
          </div>

          <div class="p-field-checkbox">
            <p-checkbox formControlName="organizationIsLegalAdressEqual" binary="true"
              inputId="organizationIsLegalAdressEqual" (onChange)="isAddressEqual('organizationActualAddress')">
            </p-checkbox>
            <label for="organizationIsLegalAdressEqual">Почтовый адрес совпадает
              с юридическим</label>
          </div>
        </div>
        <!-- 5 row -->
        <ng-container *ngIf="!isEdit">
          <div class="p-field p-col-12 p-md-6">
            <label>
              Прикрепите необходимые файлы
            </label>
            <div class="addon-button mb-20">
              <div class="addon-text">
                <p>
                  Скан-Копия свидетельства ИНН
                  организации
                </p>
              </div>
              <div class="mib-uploader">
                <input
                   type="file"
                   id="Inn"
                   accept="image/jpeg,image/png,image/gif,application/pdf"
                   (change)="onSelect($event, 'Inn')"
                   multiple="true" hidden />
                <label for="Inn" class="mib-upload"><i class="pi pi-paperclip mr-20"></i> Выбрать файлы</label>
              </div>
            </div>
            <div *ngIf="files.length">
              <ng-container *ngFor="let file of files">
                <div class="addon-button mb-10" *ngIf="file.Identifier === 'Inn'">
                  <div class="addon-text">
                    <p>
                      {{file.FileName}}
                    </p>
                  </div>
                  <div class="mib-uploader">
                    <div class="mib-upload-warn" (click)="removeFile(file)">
                      Удалить
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>

          </div>
          <div class="p-field p-col-12 p-md-6">
            <label>
              &nbsp;
            </label>
            <div class="addon-button mb-20">
              <div class="addon-text">
                <p>
                  Скан-Копия свидетельства ОГРН
                  организации
                </p>
              </div>
              <div class="mib-uploader">
                <input
                  type="file"
                  id="Ogrn"
                  (change)="onSelect($event, 'Ogrn')"
                  multiple="true"
                  accept="image/jpeg,image/png,image/gif,application/pdf"
                  hidden />
                <label for="Ogrn" class="mib-upload"><i class="pi pi-paperclip mr-20"></i> Выбрать файлы</label>
              </div>
            </div>
            <div *ngIf="files.length">
              <ng-container *ngFor="let file of files">
                <div class="addon-button mb-10" *ngIf="file.Identifier === 'Ogrn'">
                  <div class="addon-text">
                    <p>
                      {{file.FileName}}
                    </p>
                  </div>
                  <div class="mib-uploader">
                    <div class="mib-upload-warn" (click)="removeFile(file)">
                      Удалить
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>
        <div class="p-col-12">
          <h1>
            Данные о владельце сертификата
          </h1>
          <p class="description">Сертификат может быть издан только на текущего пользователя, лично заполняющего запрос
            на
            издание
            сертификата!
            В данном случае, сертификат будет издан на имя: Олег Кузнецов</p>
        </div>

        <!-- 6 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerSurname">Фамилия</label>
          <input id="ownerSurname" type="text" pInputText placeholder="Фамилия" formControlName="ownerSurname">
          <div *ngIf="formEDS.controls['ownerSurname'].invalid">
            <small *ngIf="formEDS.controls['ownerSurname'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerName">Имя</label>
          <input id="ownerName" type="text" pInputText placeholder="Имя" formControlName="ownerName">
          <div *ngIf="formEDS.controls['ownerName'].invalid">
            <small *ngIf="formEDS.controls['ownerName'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerMiddlename">Отчество</label>
          <input id="ownerMiddlename" type="text" pInputText placeholder="Отчество" formControlName="ownerMiddlename">
          <div *ngIf="formEDS.controls['ownerMiddlename'].invalid">
            <small *ngIf="formEDS.controls['ownerMiddlename'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerGender">Пол</label>
          <p-dropdown id="ownerGender" [options]="genderTypes" formControlName="ownerGender" optionLabel="title"
            optionValue="value">
          </p-dropdown>
        </div>

        <!-- 7 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerSNILS">СНИЛС</label>
          <input id="ownerSNILS" type="text" pInputText placeholder="СНИЛС" formControlName="ownerSNILS">
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerDateBurn">Дата рождения</label>
          <input id="ownerDateBurn" type="date" pInputText placeholder="Дата рождения" formControlName="ownerDateBurn">
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerPlaceBurn">Место рождения</label>
          <input id="ownerPlaceBurn" type="text" pInputText placeholder="Место рождения"
            formControlName="ownerPlaceBurn">
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="ownerPhone">Мобильный телефон</label>
          <input id="ownerPhone" type="tel" pInputText placeholder="Мобильный телефон" formControlName="ownerPhone">
        </div>

        <!-- 8 row -->
        <div class="p-field p-col-12 p-md-6">
          <label for="ownerWorkPosition">Должность</label>
          <p-dropdown id="ownerWorkPosition" [options]="postionTypes" placeholder="Выберите Должность"
            formControlName="ownerWorkPosition" optionLabel="title" optionValue="value"></p-dropdown>
        </div>
        <div class="p-field p-col-12 p-md-6">
          <label for="ownerEmail">E-mail</label>
          <input id="ownerEmail" type="email" pInputText placeholder="E-mail" formControlName="ownerEmail">
          <div *ngIf="formEDS.controls['ownerEmail'].invalid">
            <small *ngIf="formEDS.controls['ownerEmail'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <!-- 9 row -->
        <ng-container *ngIf="!isEdit">

          <div class="p-field p-col-12 p-md-6">
            <label>
              Прикрепите необходимые файлы
            </label>
            <div class="addon-button mb-20">
              <div class="addon-text">
                <p>
                  Скан-Копия СНИЛС владельца
                  ключа подписи
                </p>
              </div>
              <div class="mib-uploader">
                <input
                  type="file"
                  id="Snils"
                  (change)="onSelect($event, 'Snils')"
                  accept="image/jpeg,image/png,image/gif,application/pdf"
                  multiple="true"
                  hidden />
                <label for="Snils" class="mib-upload"><i class="pi pi-paperclip mr-20"></i> Выбрать файлы</label>
              </div>
            </div>
            <div *ngIf="files.length">
              <ng-container *ngFor="let file of files">
                <div class="addon-button mb-10" *ngIf="file.Identifier === 'Snils'">
                  <div class="addon-text">
                    <p>
                      {{file.FileName}}
                    </p>
                  </div>
                  <div class="mib-uploader">
                    <div class="mib-upload-warn" (click)="removeFile(file)">
                      Удалить
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
          <div class="p-field p-col-12 p-md-6">
            <label>
              &nbsp;
            </label>
            <div class="addon-button mb-20">
              <div class="addon-text">
                <p>
                  Скан-Копия приказа о назначении на
                  должность Генерального директора
                </p>
              </div>
              <div class="mib-uploader">
                <input
                  type="file"
                  id="Director"
                  (change)="onSelect($event, 'Director')"
                  accept="image/jpeg,image/png,image/gif,application/pdf"
                  multiple="true" hidden />
                <label for="Director" class="mib-upload"><i class="pi pi-paperclip mr-20"></i> Выбрать файлы</label>
              </div>
            </div>
            <div *ngIf="files.length">
              <ng-container *ngFor="let file of files">
                <div class="addon-button mb-10" *ngIf="file.Identifier === 'Director'">
                  <div class="addon-text">
                    <p>
                      {{file.FileName}}
                    </p>
                  </div>
                  <div class="mib-uploader">
                    <div class="mib-upload-warn" (click)="removeFile(file)">
                      Удалить
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>
        <!-- 10 row -->
        <div class="p-field p-col-12 p-md-12">
          <label for="ownerGeoPosition">Укажите географическое расположение</label>
          <p-dropdown id="ownerGeoPosition" [options]="locationTypes" placeholder="Выберите географическое расположение"
            formControlName="ownerGeoPosition" optionLabel="title" optionValue="value"></p-dropdown>
        </div>

        <div class="p-col-12">
          <div class="d-flex passport-confirm">
            <div class="passport-owner">
              <h1>Паспортные данные владельца сертификата</h1>
              <p class="description">Заполните паспортные данные</p>
            </div>
            <ng-container *ngIf="!isEdit">
              <div class="addon-button mb-20">
                <div class="addon-text">
                  <p>
                    Скан-копия паспорта
                    владельца ключа подписи
                  </p>
                </div>
                <div class="mib-uploader">
                  <input
                    type="file"
                    id="Passport"
                    (change)="onSelect($event, 'Passport')"
                    accept="image/jpeg,image/png,image/gif,application/pdf"
                    multiple="true"
                    hidden />
                  <label for="Passport" class="mib-upload"><i class="pi pi-paperclip mr-20"></i> Выбрать файлы</label>
                </div>
              </div>
              <div *ngIf="files.length">
                <ng-container *ngFor="let file of files">
                  <div class="addon-button mb-10" *ngIf="file.Identifier === 'Passport'">
                    <div class="addon-text">
                      <p>
                        {{file.FileName}}
                      </p>
                    </div>
                    <div class="mib-uploader">
                      <div class="mib-upload-warn" (click)="removeFile(file)">
                        Удалить
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- 11 row -->
        <div class="p-field p-col-12 p-md-3">
          <label for="passportNumber">Серия и номер паспорт</label>
          <input id="passportNumber" type="text" pInputText placeholder="Серия и номер паспорт"
            formControlName="passportNumber">
          <div *ngIf="formEDS.controls['passportNumber'].invalid">
            <small *ngIf="formEDS.controls['passportNumber'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="passportDate">Дата выдачи</label>
          <input id="passportDate" type="date" pInputText placeholder="Дата выдачи" formControlName="passportDate">
          <div *ngIf="formEDS.controls['passportDate'].invalid">
            <small *ngIf="formEDS.controls['passportDate'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="passportFrom">Кем выдан</label>
          <input id="passportFrom" type="text" pInputText placeholder="Кем выдан" formControlName="passportFrom">
          <div *ngIf="formEDS.controls['passportFrom'].invalid">
            <small *ngIf="formEDS.controls['passportFrom'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>
        <div class="p-field p-col-12 p-md-3">
          <label for="passportCode">Код подразделения</label>
          <input id="passportCode" type="text" pInputText placeholder="Кем подразделения"
            formControlName="passportCode">
          <div *ngIf="formEDS.controls['passportCode'].invalid">
            <small *ngIf="formEDS.controls['passportCode'].errors.required" class="p-error">
              Поле должно быть заполнено.
            </small>
          </div>
        </div>

        <div class="p-col-12">
          <h1>Внимание!</h1>
        </div>

        <div class="d-flex p-justify-between">
          <p>1. Перед тем как отправить запрос на ЭЦП, скачайте заявку на выдачу сертификата и распечатайте её на
            принтере. Она обязательно Вам понадобится при сверке документов при получении сертификата!</p>
          <button
            pButton
            pRipple
            type="button"
            (click)="getDigitalSignatureRequest()"
            label="Скачать заявку на выдачу сертификата"
            class="btn-mib-submit btn-attention"></button>
        </div>
        <p>2. После успешного сохранения запроса на ЭЦП, дождитесь приглашения от Калуги-Астрал (по e-mail) в <a
            href="#"> один из
            центров выдачи сертификатов</a> для сверки документов и получения сертификата</p>
        <p>Вы можете следить за состоянием Вашего запроса из личного кабинета по факторингу в разделе "Запросы"</p>

        <div class="p-field p-col-12 p-md-12">
          <label for="btn_submit">&nbsp;</label>
          <button id="btn_submit" pButton pRipple type="submit" label="Сохранить запрос"
            class="btn-mib-submit p-button-outlined"></button>
        </div>
      </div>
    </form>
  </ng-template>
</div>
